update WebDeferredRev..temp_jason_customerList
set 
    c.creditConsumedD1 = a.creditConsumedD1,
    c.creditConsumedD2 = a.creditConsumedD2,
    c.creditConsumedD3 = a.creditConsumedD3,
    c.creditConsumedD4 = a.creditConsumedD4,
    c.creditConsumedD5 = a.creditConsumedD5,
    c.creditConsumedD6 = a.creditConsumedD6,
    c.creditConsumedD7 = a.creditConsumedD7,
    c.creditConsumedD8 = a.creditConsumedD8,
    c.creditConsumedD9 = a.creditConsumedD9,
    c.creditConsumedD10 = a.creditConsumedD10,
    c.creditConsumedD11 = a.creditConsumedD11,
    c.creditConsumedD12 = a.creditConsumedD12,
    c.creditConsumedD13 = a.creditConsumedD13,
    c.creditConsumedD14 = a.creditConsumedD14,
    c.creditConsumedD15 = a.creditConsumedD15,
    c.creditConsumedD16 = a.creditConsumedD16,
    c.creditConsumedD17 = a.creditConsumedD17,
    c.creditConsumedD18 = a.creditConsumedD18,
    c.creditConsumedD19 = a.creditConsumedD19,
    c.creditConsumedD20 = a.creditConsumedD20,
    c.creditConsumedD21 = a.creditConsumedD21,
    c.creditConsumedD22 = a.creditConsumedD22,
    c.creditConsumedD23 = a.creditConsumedD23,
    c.creditConsumedD24 = a.creditConsumedD24,
    c.creditConsumedD25 = a.creditConsumedD25,
    c.creditConsumedD26 = a.creditConsumedD26,
    c.creditConsumedD27 = a.creditConsumedD27,
    c.creditConsumedD28 = a.creditConsumedD28,
    c.creditConsumedD29 = a.creditConsumedD29,
    c.creditConsumedD30 = a.creditConsumedD30,
    c.creditConsumedD31 = a.creditConsumedD31,
    c.creditConsumedD32 = a.creditConsumedD32,
    c.creditConsumedD33 = a.creditConsumedD33,
    c.creditConsumedD34 = a.creditConsumedD34,
    c.creditConsumedD35 = a.creditConsumedD35,
    c.creditConsumedD36 = a.creditConsumedD36,
    c.creditConsumedD37 = a.creditConsumedD37,
    c.creditConsumedD38 = a.creditConsumedD38,
    c.creditConsumedD39 = a.creditConsumedD39,
    c.creditConsumedD40 = a.creditConsumedD40,
    c.creditConsumedD41 = a.creditConsumedD41,
    c.creditConsumedD42 = a.creditConsumedD42,
    c.creditConsumedD43 = a.creditConsumedD43,
    c.creditConsumedD44 = a.creditConsumedD44,
    c.creditConsumedD45 = a.creditConsumedD45,
    c.creditConsumedD46 = a.creditConsumedD46,
    c.creditConsumedD47 = a.creditConsumedD47,
    c.creditConsumedD48 = a.creditConsumedD48,
    c.creditConsumedD49 = a.creditConsumedD49,
    c.creditConsumedD50 = a.creditConsumedD50,
    c.creditConsumedD51 = a.creditConsumedD51,
    c.creditConsumedD52 = a.creditConsumedD52,
    c.creditConsumedD53 = a.creditConsumedD53,
    c.creditConsumedD54 = a.creditConsumedD54,
    c.creditConsumedD55 = a.creditConsumedD55,
    c.creditConsumedD56 = a.creditConsumedD56,
    c.creditConsumedD57 = a.creditConsumedD57,
    c.creditConsumedD58 = a.creditConsumedD58,
    c.creditConsumedD59 = a.creditConsumedD59,
    c.creditConsumedD60 = a.creditConsumedD60,
    c.creditConsumedD61 = a.creditConsumedD61,
    c.creditConsumedD62 = a.creditConsumedD62,
    c.creditConsumedD63 = a.creditConsumedD63,
    c.creditConsumedD64 = a.creditConsumedD64,
    c.creditConsumedD65 = a.creditConsumedD65,
    c.creditConsumedD66 = a.creditConsumedD66,
    c.creditConsumedD67 = a.creditConsumedD67,
    c.creditConsumedD68 = a.creditConsumedD68,
    c.creditConsumedD69 = a.creditConsumedD69,
    c.creditConsumedD70 = a.creditConsumedD70,
    c.creditConsumedD71 = a.creditConsumedD71,
    c.creditConsumedD72 = a.creditConsumedD72,
    c.creditConsumedD73 = a.creditConsumedD73,
    c.creditConsumedD74 = a.creditConsumedD74,
    c.creditConsumedD75 = a.creditConsumedD75,
    c.creditConsumedD76 = a.creditConsumedD76,
    c.creditConsumedD77 = a.creditConsumedD77,
    c.creditConsumedD78 = a.creditConsumedD78,
    c.creditConsumedD79 = a.creditConsumedD79,
    c.creditConsumedD80 = a.creditConsumedD80,
    c.creditConsumedD81 = a.creditConsumedD81,
    c.creditConsumedD82 = a.creditConsumedD82,
    c.creditConsumedD83 = a.creditConsumedD83,
    c.creditConsumedD84 = a.creditConsumedD84,
    c.creditConsumedD85 = a.creditConsumedD85,
    c.creditConsumedD86 = a.creditConsumedD86,
    c.creditConsumedD87 = a.creditConsumedD87,
    c.creditConsumedD88 = a.creditConsumedD88,
    c.creditConsumedD89 = a.creditConsumedD89,
    c.creditConsumedD90 = a.creditConsumedD90,
    c.creditConsumedD91 = a.creditConsumedD91,
    c.creditConsumedD92 = a.creditConsumedD92,
    c.creditConsumedD93 = a.creditConsumedD93,
    c.creditConsumedD94 = a.creditConsumedD94,
    c.creditConsumedD95 = a.creditConsumedD95,
    c.creditConsumedD96 = a.creditConsumedD96,
    c.creditConsumedD97 = a.creditConsumedD97,
    c.creditConsumedD98 = a.creditConsumedD98,
    c.creditConsumedD99 = a.creditConsumedD99,
    c.creditConsumedD100 = a.creditConsumedD100,
    c.creditConsumedD101 = a.creditConsumedD101,
    c.creditConsumedD102 = a.creditConsumedD102,
    c.creditConsumedD103 = a.creditConsumedD103,
    c.creditConsumedD104 = a.creditConsumedD104,
    c.creditConsumedD105 = a.creditConsumedD105,
    c.creditConsumedD106 = a.creditConsumedD106,
    c.creditConsumedD107 = a.creditConsumedD107,
    c.creditConsumedD108 = a.creditConsumedD108,
    c.creditConsumedD109 = a.creditConsumedD109,
    c.creditConsumedD110 = a.creditConsumedD110,
    c.creditConsumedD111 = a.creditConsumedD111,
    c.creditConsumedD112 = a.creditConsumedD112,
    c.creditConsumedD113 = a.creditConsumedD113,
    c.creditConsumedD114 = a.creditConsumedD114,
    c.creditConsumedD115 = a.creditConsumedD115,
    c.creditConsumedD116 = a.creditConsumedD116,
    c.creditConsumedD117 = a.creditConsumedD117,
    c.creditConsumedD118 = a.creditConsumedD118,
    c.creditConsumedD119 = a.creditConsumedD119,
    c.creditConsumedD120 = a.creditConsumedD120,
    c.creditConsumedD121 = a.creditConsumedD121,
    c.creditConsumedD122 = a.creditConsumedD122,
    c.creditConsumedD123 = a.creditConsumedD123,
    c.creditConsumedD124 = a.creditConsumedD124,
    c.creditConsumedD125 = a.creditConsumedD125,
    c.creditConsumedD126 = a.creditConsumedD126,
    c.creditConsumedD127 = a.creditConsumedD127,
    c.creditConsumedD128 = a.creditConsumedD128,
    c.creditConsumedD129 = a.creditConsumedD129,
    c.creditConsumedD130 = a.creditConsumedD130,
    c.creditConsumedD131 = a.creditConsumedD131,
    c.creditConsumedD132 = a.creditConsumedD132,
    c.creditConsumedD133 = a.creditConsumedD133,
    c.creditConsumedD134 = a.creditConsumedD134,
    c.creditConsumedD135 = a.creditConsumedD135,
    c.creditConsumedD136 = a.creditConsumedD136,
    c.creditConsumedD137 = a.creditConsumedD137,
    c.creditConsumedD138 = a.creditConsumedD138,
    c.creditConsumedD139 = a.creditConsumedD139,
    c.creditConsumedD140 = a.creditConsumedD140,
    c.creditConsumedD141 = a.creditConsumedD141,
    c.creditConsumedD142 = a.creditConsumedD142,
    c.creditConsumedD143 = a.creditConsumedD143,
    c.creditConsumedD144 = a.creditConsumedD144,
    c.creditConsumedD145 = a.creditConsumedD145,
    c.creditConsumedD146 = a.creditConsumedD146,
    c.creditConsumedD147 = a.creditConsumedD147,
    c.creditConsumedD148 = a.creditConsumedD148,
    c.creditConsumedD149 = a.creditConsumedD149,
    c.creditConsumedD150 = a.creditConsumedD150,
    c.creditConsumedD151 = a.creditConsumedD151,
    c.creditConsumedD152 = a.creditConsumedD152,
    c.creditConsumedD153 = a.creditConsumedD153,
    c.creditConsumedD154 = a.creditConsumedD154,
    c.creditConsumedD155 = a.creditConsumedD155,
    c.creditConsumedD156 = a.creditConsumedD156,
    c.creditConsumedD157 = a.creditConsumedD157,
    c.creditConsumedD158 = a.creditConsumedD158,
    c.creditConsumedD159 = a.creditConsumedD159,
    c.creditConsumedD160 = a.creditConsumedD160,
    c.creditConsumedD161 = a.creditConsumedD161,
    c.creditConsumedD162 = a.creditConsumedD162,
    c.creditConsumedD163 = a.creditConsumedD163,
    c.creditConsumedD164 = a.creditConsumedD164,
    c.creditConsumedD165 = a.creditConsumedD165,
    c.creditConsumedD166 = a.creditConsumedD166,
    c.creditConsumedD167 = a.creditConsumedD167,
    c.creditConsumedD168 = a.creditConsumedD168,
    c.creditConsumedD169 = a.creditConsumedD169,
    c.creditConsumedD170 = a.creditConsumedD170,
    c.creditConsumedD171 = a.creditConsumedD171,
    c.creditConsumedD172 = a.creditConsumedD172,
    c.creditConsumedD173 = a.creditConsumedD173,
    c.creditConsumedD174 = a.creditConsumedD174,
    c.creditConsumedD175 = a.creditConsumedD175,
    c.creditConsumedD176 = a.creditConsumedD176,
    c.creditConsumedD177 = a.creditConsumedD177,
    c.creditConsumedD178 = a.creditConsumedD178,
    c.creditConsumedD179 = a.creditConsumedD179,
    c.creditConsumedD180 = a.creditConsumedD180
FROM WebDeferredRev..temp_jason_customerList c, wp_report..temp_jason_creditConsumed a
WHERE  a.userId = c.userId 


---initial balance just after the lastPurchase
--DROP TABLE wp_report..temp_jason_BalanceLastPurchase
SELECT a.userId, 
sum(CASE WHEN a.dateCreated <= c.dateLastPurchased THEN a.credits ELSE 0 END) as creditBalance 
INTO wp_report..temp_jason_BalanceLastPurchase
FROM WebDeferredRev..temp_jason_customerList c, wp_report..AccountTransaction a 
WHERE  
    a.creditTypeId = 1 -- regular credit 
    and a.xactionTypeId in (1,2,3,4,6) --1,2,3,4 are consumption, 6 is purchase
    and a.userId = c.userId
GROUP BY a.userId 

CREATE UNIQUE NONCLUSTERED INDEX idx_userId
    ON dbo.temp_jason_BalanceLastPurchase(userId)
go
IF EXISTS (SELECT * FROM sysindexes WHERE id=OBJECT_ID('dbo.temp_jason_BalanceLastPurchase') AND name='idx_userId')
    PRINT '<<< CREATED INDEX dbo.temp_jason_BalanceLastPurchase.idx_userId >>>'
ELSE
    PRINT '<<< FAILED CREATING INDEX dbo.temp_jason_BalanceLastPurchase.idx_userId >>>'
go


--update WebDeferredRev..temp_jason_customerList the initial balance at last purchase
update WebDeferredRev..temp_jason_customerList 
set a.initialBalance = b.creditBalance 
from WebDeferredRev..temp_jason_customerList a, wp_report..temp_jason_BalanceLastPurchase b
where a.userId = b.userId 
--779093 row(s) affected.

--update user status
update WebDeferredRev..temp_jason_customerList 
set a.userStatus = u.status
from  WebDeferredRev..temp_jason_customerList a, Member..user_info u
where a.userId = u.user_id
--636214 row(s) affected.

update WebDeferredRev..temp_jason_customerList 
set a.userStatus = u.status
from  WebDeferredRev..temp_jason_customerList a, Member..user_info_hist u
where a.userId = u.user_id

--143612 row(s) affected.

select 
    SUM(creditLastPurchased) AS credits,    
    SUM(initialBalance) as balance,
    SUM(creditConsumedD1) AS D1,
    SUM(creditConsumedD2) AS D2,
    SUM(creditConsumedD3) AS D3,
    SUM(creditConsumedD4) AS D4,
    SUM(creditConsumedD5) AS D5,
    SUM(creditConsumedD6) AS D6,
    SUM(creditConsumedD7) AS D7,
    SUM(creditConsumedD8) AS D8,
    SUM(creditConsumedD9) AS D9,
    SUM(creditConsumedD10) AS D10,
    SUM(creditConsumedD11) AS D11,
    SUM(creditConsumedD12) AS D12,
    SUM(creditConsumedD13) AS D13,
    SUM(creditConsumedD14) AS D14,
    SUM(creditConsumedD15) AS D15,
    SUM(creditConsumedD16) AS D16,
    SUM(creditConsumedD17) AS D17,
    SUM(creditConsumedD18) AS D18,
    SUM(creditConsumedD19) AS D19,
    SUM(creditConsumedD20) AS D20,
    SUM(creditConsumedD21) AS D21,
    SUM(creditConsumedD22) AS D22,
    SUM(creditConsumedD23) AS D23,
    SUM(creditConsumedD24) AS D24,
    SUM(creditConsumedD25) AS D25,
    SUM(creditConsumedD26) AS D26,
    SUM(creditConsumedD27) AS D27,
    SUM(creditConsumedD28) AS D28,
    SUM(creditConsumedD29) AS D29,
    SUM(creditConsumedD30) AS D30,
    SUM(creditConsumedD31) AS D31,
    SUM(creditConsumedD32) AS D32,
    SUM(creditConsumedD33) AS D33,
    SUM(creditConsumedD34) AS D34,
    SUM(creditConsumedD35) AS D35,
    SUM(creditConsumedD36) AS D36,
    SUM(creditConsumedD37) AS D37,
    SUM(creditConsumedD38) AS D38,
    SUM(creditConsumedD39) AS D39,
    SUM(creditConsumedD40) AS D40,
    SUM(creditConsumedD41) AS D41,
    SUM(creditConsumedD42) AS D42,
    SUM(creditConsumedD43) AS D43,
    SUM(creditConsumedD44) AS D44,
    SUM(creditConsumedD45) AS D45,
    SUM(creditConsumedD46) AS D46,
    SUM(creditConsumedD47) AS D47,
    SUM(creditConsumedD48) AS D48,
    SUM(creditConsumedD49) AS D49,
    SUM(creditConsumedD50) AS D50,
    SUM(creditConsumedD51) AS D51,
    SUM(creditConsumedD52) AS D52,
    SUM(creditConsumedD53) AS D53,
    SUM(creditConsumedD54) AS D54,
    SUM(creditConsumedD55) AS D55,
    SUM(creditConsumedD56) AS D56,
    SUM(creditConsumedD57) AS D57,
    SUM(creditConsumedD58) AS D58,
    SUM(creditConsumedD59) AS D59,
    SUM(creditConsumedD60) AS D60,
    SUM(creditConsumedD61) AS D61,
    SUM(creditConsumedD62) AS D62,
    SUM(creditConsumedD63) AS D63,
    SUM(creditConsumedD64) AS D64,
    SUM(creditConsumedD65) AS D65,
    SUM(creditConsumedD66) AS D66,
    SUM(creditConsumedD67) AS D67,
    SUM(creditConsumedD68) AS D68,
    SUM(creditConsumedD69) AS D69,
    SUM(creditConsumedD70) AS D70,
    SUM(creditConsumedD71) AS D71,
    SUM(creditConsumedD72) AS D72,
    SUM(creditConsumedD73) AS D73,
    SUM(creditConsumedD74) AS D74,
    SUM(creditConsumedD75) AS D75,
    SUM(creditConsumedD76) AS D76,
    SUM(creditConsumedD77) AS D77,
    SUM(creditConsumedD78) AS D78,
    SUM(creditConsumedD79) AS D79,
    SUM(creditConsumedD80) AS D80,
    SUM(creditConsumedD81) AS D81,
    SUM(creditConsumedD82) AS D82,
    SUM(creditConsumedD83) AS D83,
    SUM(creditConsumedD84) AS D84,
    SUM(creditConsumedD85) AS D85,
    SUM(creditConsumedD86) AS D86,
    SUM(creditConsumedD87) AS D87,
    SUM(creditConsumedD88) AS D88,
    SUM(creditConsumedD89) AS D89,
    SUM(creditConsumedD90) AS D90,
    SUM(creditConsumedD91) AS D91,
    SUM(creditConsumedD92) AS D92,
    SUM(creditConsumedD93) AS D93,
    SUM(creditConsumedD94) AS D94,
    SUM(creditConsumedD95) AS D95,
    SUM(creditConsumedD96) AS D96,
    SUM(creditConsumedD97) AS D97,
    SUM(creditConsumedD98) AS D98,
    SUM(creditConsumedD99) AS D99,
    SUM(creditConsumedD100) AS D100,
    SUM(creditConsumedD101) AS D101,
    SUM(creditConsumedD102) AS D102,
    SUM(creditConsumedD103) AS D103,
    SUM(creditConsumedD104) AS D104,
    SUM(creditConsumedD105) AS D105,
    SUM(creditConsumedD106) AS D106,
    SUM(creditConsumedD107) AS D107,
    SUM(creditConsumedD108) AS D108,
    SUM(creditConsumedD109) AS D109,
    SUM(creditConsumedD110) AS D110,
    SUM(creditConsumedD111) AS D111,
    SUM(creditConsumedD112) AS D112,
    SUM(creditConsumedD113) AS D113,
    SUM(creditConsumedD114) AS D114,
    SUM(creditConsumedD115) AS D115,
    SUM(creditConsumedD116) AS D116,
    SUM(creditConsumedD117) AS D117,
    SUM(creditConsumedD118) AS D118,
    SUM(creditConsumedD119) AS D119,
    SUM(creditConsumedD120) AS D120,
    SUM(creditConsumedD121) AS D121,
    SUM(creditConsumedD122) AS D122,
    SUM(creditConsumedD123) AS D123,
    SUM(creditConsumedD124) AS D124,
    SUM(creditConsumedD125) AS D125,
    SUM(creditConsumedD126) AS D126,
    SUM(creditConsumedD127) AS D127,
    SUM(creditConsumedD128) AS D128,
    SUM(creditConsumedD129) AS D129,
    SUM(creditConsumedD130) AS D130,
    SUM(creditConsumedD131) AS D131,
    SUM(creditConsumedD132) AS D132,
    SUM(creditConsumedD133) AS D133,
    SUM(creditConsumedD134) AS D134,
    SUM(creditConsumedD135) AS D135,
    SUM(creditConsumedD136) AS D136,
    SUM(creditConsumedD137) AS D137,
    SUM(creditConsumedD138) AS D138,
    SUM(creditConsumedD139) AS D139,
    SUM(creditConsumedD140) AS D140,
    SUM(creditConsumedD141) AS D141,
    SUM(creditConsumedD142) AS D142,
    SUM(creditConsumedD143) AS D143,
    SUM(creditConsumedD144) AS D144,
    SUM(creditConsumedD145) AS D145,
    SUM(creditConsumedD146) AS D146,
    SUM(creditConsumedD147) AS D147,
    SUM(creditConsumedD148) AS D148,
    SUM(creditConsumedD149) AS D149,
    SUM(creditConsumedD150) AS D150
FROM wp_report..temp_jason_customerList
--where userStatus = "A" and initialBalance < 500 
where date2ndLastPurchase is not null

select convert(varchar(12), dateCreated, 107) as date, 
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) as purchase,
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) as consumption
from arch_Accounting..AccountTransaction
where dateCreated >= "feb 1 2004"
group by convert(varchar(12), dateCreated, 107)
--date	purchase	consumption
Feb 01, 2004	240838	-218155 = 22683 90% 
Feb 02, 2004	265411	-239605
Feb 03, 2004	282014	-262233
Feb 04, 2004	264084	-251399
Feb 05, 2004	270393	-236131
Feb 06, 2004	268798	-247113
Feb 07, 2004	259317	-231217
Feb 08, 2004	247975	-227597
Feb 09, 2004	271713	-250007
Feb 10, 2004	249410	-235451
Feb 11, 2004	244261	-241235
Feb 12, 2004	244360	-222638
Feb 13, 2004	245489	-228577
Feb 14, 2004	238539	-216579
Feb 15, 2004	225240	-208812
Feb 16, 2004	283208	-253201
Feb 17, 2004	263813	-235868
Feb 18, 2004	277103	-252469
Feb 19, 2004	236120	-233171
Feb 20, 2004	102374	-90845

select convert(varchar(12), dateCreated, 107) as date, 
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) as purchase,
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) as consumption,
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) + 
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) 
from arch_Accounting..AccountTransaction
where dateCreated >= "feb 1 2003" and dateCreated <= "feb 20 2003"
group by convert(varchar(12), dateCreated, 107)

--date	purchase	consumption	
Feb 01, 2003	220065	-160258	59807 = 73%
Feb 02, 2003	213985	-158503	55482 = 74%
Feb 03, 2003	229485	-172842	56643 = 
Feb 04, 2003	251480	-187147	64333
Feb 05, 2003	224803	-175016	49787
Feb 06, 2003	235534	-173975	61559
Feb 07, 2003	273758	-175550	98208
Feb 08, 2003	258700	-168957	89743
Feb 09, 2003	245185	-164709	80476
Feb 10, 2003	260693	-180306	80387
Feb 11, 2003	275823	-187319	88504
Feb 12, 2003	260286	-184100	76186
Feb 13, 2003	234771	-166734	68037
Feb 14, 2003	238885	-171610	67275
Feb 15, 2003	232515	-157291	75224


select convert(varchar(12), dateCreated, 107) as date, 
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) as purchase,
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) as consumption,
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) + 
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) 
from wp_report..AccountTransaction
where dateCreated >= "feb 1 2002" and dateCreated <= "feb 15 2002"
group by convert(varchar(12), dateCreated, 107)

date	purchase	consumption	
Feb 01, 2002	233092	-130930	102162 
Feb 02, 2002	248325	-146571	101754
Feb 03, 2002	208910	-137758	71152
Feb 04, 2002	205435	-141790	63645
Feb 05, 2002	218322	-153417	64905
Feb 06, 2002	205887	-150640	55247
Feb 07, 2002	178976	-139921	39055
Feb 08, 2002	158400	-145442	12958
Feb 09, 2002	164185	-132166	32019
Feb 10, 2002	170455	-134470	35985
Feb 11, 2002	175444	-140810	34634
Feb 12, 2002	181651	-148099	33552
Feb 13, 2002	185113	-143705	41408
Feb 14, 2002	177030	-138848	38182

select convert(varchar(12), dateCreated, 107) as date, 
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) as purchase,
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) as consumption,
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) + 
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) 
from wp_report..AccountTransaction
where dateCreated >= "oct 1 2002" and dateCreated <= "oct 15 2002"
group by convert(varchar(12), dateCreated, 107)
--date	purchase	consumption	
Oct 01, 2002	228462	-205771	22691
Oct 02, 2002	220239	-201218	19021
Oct 03, 2002	196390	-183093	13297
Oct 04, 2002	217814	-193607	24207
Oct 05, 2002	184550	-175044	9506
Oct 06, 2002	174970	-169597	5373
Oct 07, 2002	211196	-208250	2946
Oct 08, 2002	218330	-206347	11983
Oct 09, 2002	206426	-196459	9967
Oct 10, 2002	202762	-187081	15681
Oct 11, 2002	213239	-194153	19086
Oct 12, 2002	186490	-168719	17771
Oct 13, 2002	181880	-163118	18762
Oct 14, 2002	213225	-204025	9200

select datepart(yy,dateCreated) as year, 
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) as purchase,
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) as consumption,
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) + 
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) 
from wp_report..AccountTransaction
group by datepart(yy,dateCreated)

--year	purchase	consumption	
1998	2412771	-1505410	907361
1999	9175513	-7588497	1587016
2000	18773849	-15713586	3060263
2001	36087595	-32624985	3462610
2002	71413030	-64185546	7227484
2003	93064560	-83184510	9880050
2004	13312859	-12105123	1207736


select convert(varchar(12), dateCreated, 107) as date, 
count(distinct userId) as purchase
from arch_Accounting..AccountTransaction
where dateCreated >= "feb 1 2004" and xactionTypeId = 6 and creditTypeId = 1
group by convert(varchar(12), dateCreated, 107)
--date	purchase
Feb 01, 2004	2626
Feb 02, 2004	2889
Feb 03, 2004	3121
Feb 04, 2004	2909
Feb 05, 2004	2864
Feb 06, 2004	2890
Feb 07, 2004	2780
Feb 08, 2004	2672
Feb 09, 2004	2975
Feb 10, 2004	2750
Feb 11, 2004	2725
Feb 12, 2004	2648
Feb 13, 2004	2752
Feb 14, 2004	2602
Feb 15, 2004	2493
Feb 16, 2004	3101
Feb 17, 2004	2880
Feb 18, 2004	3068
Feb 19, 2004	2665
Feb 20, 2004	1131

select convert(varchar(12), dateCreated, 107) as date, 
count(distinct userId) as purchase
from arch_Accounting..AccountTransaction
where dateCreated >= "feb 1 2004" and xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1
group by convert(varchar(12), dateCreated, 107)
--date	purchase
Feb 01, 2004	16854
Feb 02, 2004	18254
Feb 03, 2004	20558
Feb 04, 2004	19967
Feb 05, 2004	19007
Feb 06, 2004	19390
Feb 07, 2004	17714
Feb 08, 2004	17504
Feb 09, 2004	19418
Feb 10, 2004	19121
Feb 11, 2004	19429
Feb 12, 2004	18343
Feb 13, 2004	18142
Feb 14, 2004	16695
Feb 15, 2004	16018
Feb 16, 2004	19236
Feb 17, 2004	19004
Feb 18, 2004	19781
Feb 19, 2004	18994
Feb 20, 2004	9075

select 
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) ,
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end),
sum(case when xactionTypeId = 6 and creditTypeId = 1 then credits else 0 end) + 
sum(case when xactionTypeId >= 1 and xactionTypeId <= 4 and creditTypeId = 1 then credits else 0 end) 
from arch_Accounting..AccountTransaction
--where dateCreated >= "feb 1 2004" --purchase	consumption  4980460	-4582303 = 398157 / 20 days = 19907
--where dateCreated >= "jan 1 2004" --purchase	consumption  13559435	-12338394 = 1221041 / 50 days = 24420
--where dateCreated >= "dec 1 2003" --purchase	consumption  21251922	-19474574 = 1777348 / 80 days = 22216
--where dateCreated >= "oct 1 2003" --purchase	consumption  37683716	-34340869 =	3342847 / 140 days = 23163
--where dateCreated >= "jun 1 2003" --purchase	consumption  69626793	-60750519 =	8876274 / 260 days = 34139


--date 2nd Last purchase
select a.userId, max(a.dateCreated) as date2ndLastPurchased
into wp_report..temp_jason_date2ndLastBuy
from wp_report..AccountTransaction a, wp_report..temp_jason_customerList b
where a.userId = b.userId and a.dateCreated < b.dateLastPurchased and a.xactionTypeId = 6 and a.creditTypeId = 1
group by a.userId

--337224 row(s) affected.

CREATE UNIQUE NONCLUSTERED INDEX idx_userId
    ON dbo.temp_jason_date2ndLastBuy(userId)
go
IF EXISTS (SELECT * FROM sysindexes WHERE id=OBJECT_ID('dbo.temp_jason_date2ndLastBuy') AND name='idx_userId')
    PRINT '<<< CREATED INDEX dbo.temp_jason_date2ndLastBuy.idx_userId >>>'
ELSE
    PRINT '<<< FAILED CREATING INDEX dbo.temp_jason_date2ndLastBuy.idx_userId >>>'
go

--update date 2nd Last purchase
update wp_report..temp_jason_customerList 
set a.date2ndLastPurchase = b.date2ndLastPurchased
from  wp_report..temp_jason_customerList a, wp_report..temp_jason_date2ndLastBuy b
where a.userId = b.userId
--337224 row(s) affected.

--=====purchase inteval 
select avg(datediff(dd,date2ndLastPurchase,dateLastPurchased))
from wp_report..temp_jason_customerList
where date2ndLastPurchase is not null
--91 average purchase interval

select userId, datediff(dd,date2ndLastPurchase,dateLastPurchased) as purchaseInterval
into wp_report..temp_jason_purchaseInterval
from wp_report..temp_jason_customerList
where date2ndLastPurchase is not null

select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 150 --274682
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 180 --285820
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 210 --294553
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 240 --301499
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 360 --318858
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 390 --321502
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 420 --323740
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 450 --325564
select count(*) from wp_report..temp_jason_purchaseInterval where purchaseInterval <= 500 --328034

--========== how many paid member =============
select count(*) from Member..user_info where user_type = "P" --650738
select count(*) from Member..user_info_hist where user_type = "P" --151827


--========= first purhase and last purchase
SELECT p.userId as userId,
    Max(p.dateCreated) as dateLastPurchased,
    Min(p.dateCreated) as dateFirstPurchased,
    convert(datetime, 'jan 1 1970') as date2ndLastPurchased, 
    0 as creditLastPurchased,     
    0 as credit2ndLastPurchased, 
    0 as initialBalanceLast,     
    0 as initialBalance2ndLast,     
   0 as creditConsumedD30Last,
   0 as creditConsumedD60Last,
   0 as creditConsumedD90Last,
   0 as creditConsumedD120Last,
   0 as creditConsumedD150Last,
   0 as creditConsumedD180Last,
   0 as creditConsumedD210Last,
   0 as creditConsumedD30Last2nd,
   0 as creditConsumedD60Last2nd,
   0 as creditConsumedD90Last2nd,
   0 as creditConsumedD120Last2nd,
   0 as creditConsumedD150Last2nd,
   0 as creditConsumedD180Last2nd,
   0 as creditConsumedD210Last2nd
INTO wp_report..temp_jason_customerList30
FROM wp_report..AccountTransaction p
WHERE p.dateCreated < "feb 1 2004" and p.xactionTypeId = 6  and p.creditTypeId = 1
GROUP BY userId
--778999 row(s) affected.

update wp_report..temp_jason_customerList30
set a.date2ndLastPurchased = b.date2ndLastPurchase, 
    a.creditLastPurchased = b.creditLastPurchased,     
--    a.credit2ndLastPurchased, 
    a.initialBalanceLast = b.initialBalance  
--    0 as initialBalance2ndLast,     
from wp_report..temp_jason_customerList30 a, wp_report..temp_jason_customerList b
where a.userId = b.userId 

select count(*) from wp_report..temp_jason_customerList30 where date2ndLastPurchased is null              -- 441775 rows
select count(*) from wp_report..temp_jason_customerList30 where date2ndLastPurchased is not null          -- 337224 rows
select count(*) from wp_report..temp_jason_customerList30 where dateFirstPurchased = date2ndLastPurchased -- 119566 rows
select count(*) from wp_report..temp_jason_customerList30 
    where date2ndLastPurchased is not null and dateFirstPurchased != date2ndLastPurchased                 -- 217658 rows

--drop table wp_report..temp_jason_creditConsumed30
SELECT a.userId ,
    SUM(CASE WHEN a.dateCreated >= dateadd(dd,0, c.date2ndLastPurchased)  and a.dateCreated < dateadd(dd,31,c.date2ndLastPurchased)  THEN a.credits ELSE 0 END) AS creditConsumedD30,
    SUM(CASE WHEN a.dateCreated >= dateadd(dd,31, c.date2ndLastPurchased)  and a.dateCreated < dateadd(dd,61,c.date2ndLastPurchased)  THEN  a.credits ELSE 0 END) AS creditConsumedD60,
    SUM(CASE WHEN a.dateCreated >= dateadd(dd,61, c.date2ndLastPurchased)  and a.dateCreated < dateadd(dd,91,c.date2ndLastPurchased)  THEN  a.credits ELSE 0 END) AS creditConsumedD90,
    SUM(CASE WHEN a.dateCreated >= dateadd(dd,91, c.date2ndLastPurchased)  and a.dateCreated < dateadd(dd,121,c.date2ndLastPurchased)  THEN a.credits ELSE 0 END) AS creditConsumedD120,
    SUM(CASE WHEN a.dateCreated >= dateadd(dd,121, c.date2ndLastPurchased)  and a.dateCreated < dateadd(dd,151,c.date2ndLastPurchased)  THEN a.credits ELSE 0 END) AS creditConsumedD150,
    SUM(CASE WHEN a.dateCreated >= dateadd(dd,151, c.date2ndLastPurchased)  and a.dateCreated < dateadd(dd,181,c.date2ndLastPurchased)  THEN a.credits ELSE 0 END) AS creditConsumedD180,
    SUM(CASE WHEN a.dateCreated >= dateadd(dd,181, c.date2ndLastPurchased)  and a.dateCreated < dateadd(dd,211,c.date2ndLastPurchased)  THEN a.credits ELSE 0 END) AS creditConsumedD210
INTO wp_report..temp_jason_creditConsumed30
FROM wp_report..temp_jason_customerList30 c, wp_report..AccountTransaction a 
WHERE  a.userId  = c.userId 
    and a.creditTypeId = 1 -- regular credit 
    and a.xactionTypeId >= 1 and a.xactionTypeId <= 4 --consumption
    and a.dateCreated > c.date2ndLastPurchased and a.dateCreated < c.dateLastPurchased
group by a.userId
--330970 row(s) affected. somebody no consumption

--update wp_report..temp_jason_customerList30
update wp_report..temp_jason_customerList30
set 
   a.creditConsumedD30Last2nd = b.creditConsumedD30,
   a.creditConsumedD60Last2nd = b.creditConsumedD60,
   a.creditConsumedD90Last2nd = b.creditConsumedD90,
   a.creditConsumedD120Last2nd = b.creditConsumedD120,
   a.creditConsumedD150Last2nd = b.creditConsumedD150,
   a.creditConsumedD180Last2nd = b.creditConsumedD180,
   a.creditConsumedD210Last2nd = b.creditConsumedD210
from wp_report..temp_jason_customerList30 a,  wp_report..temp_jason_creditConsumed30 b
where a.userId= b.userId
--330970 row(s) affected.

update wp_report..temp_jason_customerList30
set a.credit2ndLastPurchased = b.credits
from wp_report..temp_jason_customerList30 a, wp_report..AccountTransaction b
where a.userId = b.userId and a.date2ndLastPurchased = b.dateCreated
--337224 row(s) affected.

select 
   avg(credit2ndLastPurchased),
   avg(creditConsumedD30Last2nd),
   avg(creditConsumedD60Last2nd),
   avg(creditConsumedD90Last2nd),
   avg(creditConsumedD120Last2nd),
   avg(creditConsumedD150Last2nd),
   avg(creditConsumedD180Last2nd),
   avg(creditConsumedD210Last2nd)
from wp_report..temp_jason_customerList30
where date2ndLastPurchased is not null 
--79	-59	-7	-3	-1	-1	0	0




